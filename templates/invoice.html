<!doctype html>
<html>
    <head>
        <title>Factur-X Generator</title>
        <meta charset="UTF-8" />
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                max-width: 900px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
            }
            h1 {
                color: #333;
            }
            h3 {
                color: #555;
                margin-top: 20px;
            }
            form {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .field-group {
                margin-bottom: 15px;
            }
            .field-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
                color: #333;
            }
            .field-group input {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }
            .field-group input:focus {
                outline: none;
                border-color: #007cba;
            }
            .field-group input.error {
                border-color: #dc3545;
                background-color: #fff5f5;
            }
            .field-error {
                color: #dc3545;
                font-size: 12px;
                margin-top: 4px;
            }
            .line {
                border: 1px solid #ddd;
                margin: 10px 0;
                padding: 15px;
                border-radius: 4px;
                background: #fafafa;
                display: flex;
                gap: 10px;
                align-items: flex-end;
                flex-wrap: wrap;
            }
            .line.error {
                border-color: #dc3545;
                background-color: #fff5f5;
            }
            .line .field {
                flex: 1;
                min-width: 100px;
            }
            .line .field label {
                display: block;
                margin-bottom: 4px;
                font-size: 12px;
                color: #666;
            }
            .line .field input {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            .line .field input.error {
                border-color: #dc3545;
            }
            .line button {
                padding: 8px 12px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .line button:hover {
                background: #c82333;
            }
            .btn {
                background: #007cba;
                color: white;
                padding: 12px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                margin-right: 10px;
                margin-top: 10px;
            }
            .btn:hover {
                background: #005a87;
            }
            .btn-secondary {
                background: #6c757d;
            }
            .btn-secondary:hover {
                background: #545b62;
            }
            .errors-container {
                background: #f8d7da;
                border: 1px solid #f5c6cb;
                color: #721c24;
                padding: 15px;
                border-radius: 4px;
                margin-bottom: 20px;
                display: none;
            }
            .errors-container h4 {
                margin: 0 0 10px 0;
            }
            .errors-container ul {
                margin: 0;
                padding-left: 20px;
            }
            .success-container {
                background: #d4edda;
                border: 1px solid #c3e6cb;
                color: #155724;
                padding: 15px;
                border-radius: 4px;
                margin-bottom: 20px;
                display: none;
            }
            .field-row {
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
            }
            .field-row .field-group {
                flex: 1;
                min-width: 200px;
            }
            .field-row .field-group.small {
                flex: 0 0 150px;
                min-width: 120px;
            }
            .field-group select {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                background: white;
            }
            .field-group select:focus {
                outline: none;
                border-color: #007cba;
            }
            .field-group select.error {
                border-color: #dc3545;
                background-color: #fff5f5;
            }
            .section-info {
                font-size: 12px;
                color: #666;
                margin-bottom: 15px;
                font-style: italic;
            }
        </style>
    </head>
    <body>
        <h1>Facture Factur-X</h1>
        <p>
            Emetteur: <strong>{{ emitter.name }}</strong> (SIRET: {{
            emitter.siret }})
        </p>

        <div id="errorsContainer" class="errors-container">
            <h4>Erreurs de validation</h4>
            <ul id="errorsList"></ul>
        </div>

        <div id="successContainer" class="success-container">
            <p id="successMessage"></p>
        </div>

        <form id="invoiceForm">
            <h3>Informations de la facture</h3>
            <p class="section-info">
                Champs obligatoires selon la norme Factur-X (profil
                MINIMUM/BASIC)
            </p>

            <div class="field-row">
                <div class="field-group">
                    <label for="invoice_number"
                        >Numero de facture (BT-1) *</label
                    >
                    <input
                        type="text"
                        name="invoice_number"
                        id="invoice_number"
                        placeholder="Ex: FAC-2024-0001"
                        required
                    />
                    <div class="field-error" data-field="invoice_number"></div>
                </div>
                <div class="field-group small">
                    <label for="type_code">Type de document (BT-3) *</label>
                    <select name="type_code" id="type_code" required>
                        <option value="380" selected>Facture (380)</option>
                        <option value="381">Avoir (381)</option>
                        <option value="384">Facture rectificative (384)</option>
                        <option value="389">Facture d'acompte (389)</option>
                    </select>
                    <div class="field-error" data-field="type_code"></div>
                </div>
            </div>

            <div class="field-row">
                <div class="field-group">
                    <label for="issue_date">Date d'emission (BT-2) *</label>
                    <input
                        type="date"
                        name="issue_date"
                        id="issue_date"
                        required
                    />
                    <div class="field-error" data-field="issue_date"></div>
                </div>
                <div class="field-group">
                    <label for="due_date">Date d'echeance (BT-9)</label>
                    <input type="date" name="due_date" id="due_date" />
                    <div class="field-error" data-field="due_date"></div>
                </div>
                <div class="field-group small">
                    <label for="currency_code">Devise (BT-5) *</label>
                    <select name="currency_code" id="currency_code" required>
                        <option value="EUR" selected>EUR</option>
                        <option value="USD">USD</option>
                        <option value="GBP">GBP</option>
                        <option value="CHF">CHF</option>
                    </select>
                    <div class="field-error" data-field="currency_code"></div>
                </div>
            </div>

            <div class="field-row">
                <div class="field-group">
                    <label for="buyer_reference"
                        >Reference acheteur (BT-10)</label
                    >
                    <input
                        type="text"
                        name="buyer_reference"
                        id="buyer_reference"
                        placeholder="Ex: Service Comptabilite"
                    />
                    <div class="field-error" data-field="buyer_reference"></div>
                </div>
                <div class="field-group">
                    <label for="purchase_order_reference"
                        >N° bon de commande (BT-13)</label
                    >
                    <input
                        type="text"
                        name="purchase_order_reference"
                        id="purchase_order_reference"
                        placeholder="Ex: BC-2024-0042"
                    />
                    <div
                        class="field-error"
                        data-field="purchase_order_reference"
                    ></div>
                </div>
            </div>

            <div class="field-group">
                <label for="payment_terms"
                    >Conditions de paiement (BT-20)</label
                >
                <input
                    type="text"
                    name="payment_terms"
                    id="payment_terms"
                    placeholder="Ex: Paiement a 30 jours fin de mois"
                />
                <div class="field-error" data-field="payment_terms"></div>
            </div>

            <h3>Destinataire (Acheteur)</h3>
            <div class="field-group">
                <label for="recipient_name"
                    >Nom / Raison sociale (BT-44) *</label
                >
                <input
                    type="text"
                    name="recipient_name"
                    id="recipient_name"
                    placeholder="Ex: Entreprise ABC"
                    required
                />
                <div class="field-error" data-field="recipient_name"></div>
            </div>

            <div class="field-row">
                <div class="field-group">
                    <label for="recipient_siret">SIRET (BT-47) *</label>
                    <input
                        type="text"
                        name="recipient_siret"
                        id="recipient_siret"
                        placeholder="Ex: 12345678901234"
                        required
                        maxlength="14"
                    />
                    <div class="field-error" data-field="recipient_siret"></div>
                </div>
                <div class="field-group">
                    <label for="recipient_vat_number"
                        >N° TVA intracommunautaire (BT-48)</label
                    >
                    <input
                        type="text"
                        name="recipient_vat_number"
                        id="recipient_vat_number"
                        placeholder="Ex: FR12345678901"
                    />
                    <div
                        class="field-error"
                        data-field="recipient_vat_number"
                    ></div>
                </div>
            </div>

            <div class="field-row">
                <div class="field-group">
                    <label for="recipient_address"
                        >Adresse (BT-50 a BT-54)</label
                    >
                    <input
                        type="text"
                        name="recipient_address"
                        id="recipient_address"
                        placeholder="Ex: 10 rue de Paris, 75001 Paris"
                    />
                    <div
                        class="field-error"
                        data-field="recipient_address"
                    ></div>
                </div>
                <div class="field-group small">
                    <label for="recipient_country_code"
                        >Code pays (BT-55) *</label
                    >
                    <select
                        name="recipient_country_code"
                        id="recipient_country_code"
                        required
                    >
                        <option value="FR" selected>FR - France</option>
                        <option value="BE">BE - Belgique</option>
                        <option value="CH">CH - Suisse</option>
                        <option value="DE">DE - Allemagne</option>
                        <option value="ES">ES - Espagne</option>
                        <option value="IT">IT - Italie</option>
                        <option value="LU">LU - Luxembourg</option>
                        <option value="GB">GB - Royaume-Uni</option>
                    </select>
                    <div
                        class="field-error"
                        data-field="recipient_country_code"
                    ></div>
                </div>
            </div>

            <h3>Lignes de facturation</h3>
            <div class="field-error" data-field="lines"></div>
            <div id="lines">
                <div class="line" data-id="0">
                    <div class="field" style="flex: 2">
                        <label>Description *</label>
                        <input
                            name="lines[0][description]"
                            placeholder="Description du produit/service"
                        />
                    </div>
                    <div class="field">
                        <label>Quantite *</label>
                        <input
                            name="lines[0][quantity]"
                            type="number"
                            step="0.01"
                            min="0.01"
                            placeholder="1"
                        />
                    </div>
                    <div class="field">
                        <label>Prix unitaire HT *</label>
                        <input
                            name="lines[0][unit_price_ht]"
                            type="number"
                            step="0.01"
                            min="0.01"
                            placeholder="0.00"
                        />
                    </div>
                    <div class="field">
                        <label>TVA %</label>
                        <input
                            name="lines[0][vat_rate]"
                            type="number"
                            step="0.01"
                            min="0"
                            max="100"
                            placeholder="20"
                            value="20"
                        />
                    </div>
                    <button type="button" onclick="removeLine(this)">
                        Supprimer
                    </button>
                </div>
            </div>
            <button type="button" class="btn btn-secondary" onclick="addLine()">
                + Ajouter une ligne
            </button>

            <div
                style="
                    margin-top: 20px;
                    border-top: 1px solid #ddd;
                    padding-top: 20px;
                "
            >
                <button type="submit" class="btn">Generer Factur-X</button>
            </div>
        </form>

        <script>
            let lineCount = 1;

            function addLine() {
                const lines = document.getElementById("lines");
                const template = document.querySelector(".line");
                const newLine = template.cloneNode(true);
                const newIndex = lineCount++;

                newLine.dataset.id = newIndex;
                newLine.classList.remove("error");

                // Met a jour les noms des champs avec le nouvel index
                newLine.querySelectorAll("input").forEach((input) => {
                    input.name = input.name.replace(/\[\d+\]/, `[${newIndex}]`);
                    input.value = input.name.includes("vat_rate") ? "20" : "";
                    input.classList.remove("error");
                });

                // Reattache l'evenement onclick
                newLine.querySelector("button").onclick = function () {
                    removeLine(this);
                };

                lines.appendChild(newLine);
            }

            function removeLine(btn) {
                const lines = document.getElementById("lines");
                if (lines.children.length > 1) {
                    btn.parentElement.remove();
                } else {
                    alert("La facture doit contenir au moins une ligne");
                }
            }

            function clearErrors() {
                // Cache le conteneur d'erreurs
                document.getElementById("errorsContainer").style.display =
                    "none";
                document.getElementById("errorsList").innerHTML = "";
                document.getElementById("successContainer").style.display =
                    "none";

                // Retire les classes d'erreur des champs
                document
                    .querySelectorAll(".error")
                    .forEach((el) => el.classList.remove("error"));
                document
                    .querySelectorAll(".field-error")
                    .forEach((el) => (el.textContent = ""));
            }

            function displayErrors(errors) {
                clearErrors();

                if (!errors || errors.length === 0) return;

                const container = document.getElementById("errorsContainer");
                const list = document.getElementById("errorsList");

                errors.forEach((error) => {
                    // Ajoute a la liste globale
                    const li = document.createElement("li");
                    li.textContent = error.message;
                    list.appendChild(li);

                    // Marque le champ en erreur
                    const fieldName = error.field;
                    const input = document.querySelector(
                        `[name="${fieldName}"]`,
                    );
                    if (input) {
                        input.classList.add("error");

                        // Si c'est une ligne, marque aussi le conteneur
                        const lineContainer = input.closest(".line");
                        if (lineContainer) {
                            lineContainer.classList.add("error");
                        }
                    }

                    // Affiche le message sous le champ
                    const errorDiv = document.querySelector(
                        `[data-field="${fieldName}"]`,
                    );
                    if (errorDiv) {
                        errorDiv.textContent = error.message;
                    }
                });

                container.style.display = "block";
                container.scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                });
            }

            function displaySuccess(message) {
                clearErrors();
                const container = document.getElementById("successContainer");
                document.getElementById("successMessage").textContent = message;
                container.style.display = "block";
            }

            document.getElementById("invoiceForm").onsubmit = async (e) => {
                e.preventDefault();
                clearErrors();

                const formData = new FormData(e.target);

                try {
                    const response = await fetch("/invoice", {
                        method: "POST",
                        body: formData,
                    });

                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        displayErrors(data.errors);
                        return;
                    }

                    // Succes
                    displaySuccess(
                        `${data.message} - Facture n°${data.invoice_number} - Total HT: ${data.total_ht.toFixed(2)} EUR - TVA: ${data.total_vat.toFixed(2)} EUR - Total TTC: ${data.total_ttc.toFixed(2)} EUR`,
                    );

                    // TODO: Quand le PDF sera genere, telecharger le fichier
                    // const blob = await response.blob();
                    // const url = URL.createObjectURL(blob);
                    // const a = document.createElement("a");
                    // a.href = url;
                    // a.download = "facture.factur-x.pdf";
                    // a.click();
                } catch (error) {
                    displayErrors([
                        {
                            field: "_form",
                            message:
                                "Erreur de communication avec le serveur: " +
                                error.message,
                        },
                    ]);
                }
            };
        </script>
    </body>
</html>
